<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeMOT - Stats d'un Wordle fran√ßais</title>
  <meta name="description" content="Les statistiques de LeMOT, un des Wordle en fran√ßais">
  <link rel="canonical" href="https://www.solitaire-play.com/lemot/stats.html">
  <link rel="stylesheet" href="lemot.min.css">
  <link rel="shortcut icon" href="/lemot/images/favicon.ico">
  <style>
    .popup { display: block; }
    #resultats { height: 360px; width: 45ch; user-select: text; }
    #excel { height: 75px; width: 100%; user-select: text; }
  </style>
</head>

<body id="lemot">

  <div class="container">

    <div class="popup resultats">
      <div class="header">
        <h2>R√©sultat</h2>
        <h2 id="links"></h2>
      </div>
      <h3></h3>
      <p>
        <textarea id="resultats"></textarea>
      </p>
      <p>
        <button class="correct" id="calculer">
          GENERER
        </button>
      </p>
      <p>
        <textarea id="excel"></textarea>
      </p>
      <p>Il y a un chat du 14 juillet...</p>
    </div>

  </div>

  <script>
    const $links = document.querySelector("#links");
    $links.innerHTML = `<a target='_blank' href="${GetLink(GetPuzzle() - 1)}">MOT</a> / `
                     + `<a target='_blank' href="${GetLink(GetPuzzle() - 1 - 56)}">MOT6</a> / `
                     + `<a target='_blank' href="${GetLink("fleur-" + GetPuzzleBee())}">BEE</a>`;

    const $calculer = document.querySelector("#calculer");
    const $resultats = document.querySelector("#resultats");
    const $excel = document.querySelector("#excel");
    let sauvegarde = "";
    $resultats.addEventListener("paste", Nettoyage, false);
    $calculer.addEventListener("click", Statistiques, false);

    const NIVOS = [
      "C'est parti",
      "Pas mal",
      "En progr√®s",
      "Bien",
      "Fortiche",
      "Joli",
      "Super",
      "√âpatant",
      "G√©nial",
      "Formidable",
    ];

    function Nettoyage() {
      setTimeout(function() { Nettoyage2(); }, 0)
    }

    function Nettoyage2() {
      let contenu = $resultats.value.trim()
      contenu = contenu.replaceAll(" √©v√®nement", "");
      contenu = contenu.replaceAll("(pas de titre) \t\n", "");
      contenu = contenu.replaceAll("(pas de titre)", "");
      $resultats.value = contenu;
    }

    function Statistiques() {
      // R√©cup√®re le contenu source ou g√©n√©r√©
      const contenu = $resultats.value.trim();
      // Revient aux donn√©es sources quand statistiques sont d√©j√† affich√©es
      if (contenu.includes("üüß") || contenu.includes("üü†") || contenu.includes("üü¶")) {
        $resultats.value = sauvegarde;
        $calculer.textContent = "GENERER";
        return;
      }
      // Sauvegarde les donn√©es sources avant de g√©n√©rer les statistiques
      sauvegarde = contenu;
      const lemot6 = contenu.includes("lemot6");
      const labee = contenu.includes("fleur");
      // Nettoyage du copier / coller de GoatCounter
      const stats = contenu.split('\n')
                           .filter(x => x.includes("puzzle") || x.includes("lemot6") || x.includes("fleur"))
                           .map(x => x.replace(" \t", "-").replace("‚ÄØ", "").replace("-X", "-7").split("-"));
      console.dir(stats);
      // Comptabilise pour chaque r√©sultats
      // - 0 : nombre de parties entam√©es
      // - 1 √† 6 : nombre de parties gagn√©es en 1 √† 6 coups
      // - 7 : nombre de parties perdues (X)
      const resultats = [ 0, 0, 0, 0, 0, 0, 0, 0 ];
      if (labee) resultats.push(0);
      if (labee) resultats.push(0);
      for (let i = 0; i < stats.length; i++) {
        const nombre = parseInt(stats[i][0], 10) || 0;
        const essai = parseInt(stats[i][3], 10) || 0;
        resultats[essai] += nombre;
      }
      // Calcule le nombre de parties termin√©es (jou√©es jusqu'au bout)
      let total = resultats.reduce((x, y) => x + y) - resultats[0];
      if (labee) {
        total = stats[0][2] === "0" ? resultats[1] : resultats[0];
        resultats[0] = total;
      }
      let excel = resultats.join("\t") + "\t" + total;
      console.log(excel);
      // Calcule le nombre de joueurs √† chaque niveau de LaBEE
      if (labee) {
        excel = resultats.join("\t");
        for (let i = 0; i < resultats.length - 1; i++)
          resultats[i] = resultats[i] - resultats[i + 1];
      }
      // Calcule le pourcentage de chaque r√©sultat par rapport au nombre de parties termin√©es
      const pourcentages = resultats.map(x => Math.round(x * 100 / total));
      const maximum = Math.max(...pourcentages);
      // G√©n√®re 1 carr√© pour chaque 4%
      let bloc = lemot6 ? "üü†" : "üüß";
      if (labee) bloc = "üü¶";
      const carres = labee
                   ? pourcentages.map(x => bloc.repeat(Math.round(x * 10 / maximum)))
                   : pourcentages.map(x => bloc.repeat(Math.round(x / 4)));
      // Retrouve le num√©ro du puzzle correspondant aux stats
      let puzzle = stats[0][2];
      // Emplacement pour le mot √† d√©couvrir de la veille
      let reponse = " #XXXXXXXXXXXXX";
      // G√©n√®re les statistiques
      let statistiques = `LeMOT #${puzzle} - ${total} parties jou√©es\n`;
      if (lemot6) statistiques = statistiques.replace("LeMOT", "LeMOT6");
      if (labee) {
        statistiques = statistiques.replace("LeMOT", "#LaBEE");
        statistiques = statistiques.replace(" #0", "");
        statistiques = statistiques.replace(" - ", " üåª ");
        statistiques = statistiques.replace(" jou√©es", "");
        reponse = "";
        for (let i = 0; i < 10; i++) {
          if (i === 9)
            carres[i] = carres[i].replaceAll("üü¶", "üüß");
          statistiques += `\n${carres[i]} ${NIVOS[i]} ${pourcentages[i]}%`;
        }
      } else {
        for (let i = 1; i < 8; i++) {
          const essais = i < 7 ? i : "X";
          statistiques += `\n${essais}: ${carres[i]} ${pourcentages[i]}%`;
        }
      }
      statistiques += `\n\n#LeMotStats #LeMotLeJeu${reponse}`;
      const url = "https://www.goatcounter.com/ + üñêÔ∏è";
      statistiques += `\n\n${url}`;
      // Affiche et logue les statistiques
      $resultats.value = statistiques;
      console.log(statistiques);
      // Affiche le d√©tail pour copie dans Excel
      $excel.value = excel;
      // Change l'intitul√© du bouton pour revoir les sources
      $calculer.textContent = "CHIFFRES";
    }

    function GetPuzzle() {
      const debut = new Date(Date.UTC(2022, 0, 9));
      const jour = new Date(Date.now());
      const difference = jour.getTime() - debut.getTime();
      return Math.ceil(difference / 1000 / 60 / 60 / 24);
    }

    function GetPuzzleBee() {
      const today = new Date();
      const debut = new Date(Date.UTC(2022, 3, 16));
      const jour = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
      const difference = jour.getTime() - debut.getTime();
      return Math.ceil(difference / 1000 / 60 / 60 / 24 / 14);
    }

    function GetLink(puzzle) {
      if (!("" + puzzle).startsWith("fleur"))
        return `https://lemot.goatcounter.com/?hl-period=week&filter=${puzzle}&daily=off`;
      let du = new Date();
      du.setDate(du.getDate() - 20);
      let au = new Date();
      au.setDate(au.getDate() - 1);
      return `https://lemot.goatcounter.com/?period-start=${GetYyyyMmDd(du)}&period-end=${GetYyyyMmDd(au)}&filter=${puzzle}&daily=off`;
    }

    function GetYyyyMmDd(dt) {
      const yyyy = dt.getUTCFullYear().toString();
      const mm = (1 + dt.getUTCMonth()).toString().padStart(2, "0");
      const dd = dt.getUTCDate().toString().padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
</script>

</body>

</html>
